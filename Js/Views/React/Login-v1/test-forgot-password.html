<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘记密码功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .step {
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 20px;
            background-color: #e9ecef;
            color: #6c757d;
        }

        .step.active {
            background-color: #007bff;
            color: white;
        }

        .step.completed {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>忘记密码功能测试</h1>

        <div class="test-section">
            <h3>1. 忘记密码流程测试</h3>
            <div class="step-indicator">
                <div class="step active" id="step1">1. 输入邮箱</div>
                <div class="step" id="step2">2. 验证码</div>
                <div class="step" id="step3">3. 重置密码</div>
            </div>

            <div id="step1-content">
                <div class="form-group">
                    <label for="email">邮箱地址:</label>
                    <input type="email" id="email" placeholder="请输入邮箱地址">
                </div>
                <button onclick="testForgotPassword()">发送重置邮件</button>
            </div>

            <div id="step2-content" style="display: none;">
                <div class="form-group">
                    <label for="code">验证码:</label>
                    <input type="text" id="code" placeholder="请输入6位验证码" maxlength="6">
                </div>
                <button onclick="testVerifyCode()">验证</button>
                <button onclick="testResendCode()">重新发送</button>
            </div>

            <div id="step3-content" style="display: none;">
                <div class="form-group">
                    <label for="newPassword">新密码:</label>
                    <input type="password" id="newPassword" placeholder="请输入新密码">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码:</label>
                    <input type="password" id="confirmPassword" placeholder="请确认新密码">
                </div>
                <button onclick="testResetPassword()">重置密码</button>
            </div>

            <div id="test-result" class="status info">点击按钮开始测试忘记密码功能</div>
        </div>

        <div class="test-section">
            <h3>2. API接口测试</h3>
            <button onclick="testForgotPasswordAPI()">测试忘记密码API</button>
            <button onclick="testResetPasswordAPI()">测试重置密码API</button>
            <button onclick="testSendEmailCodeAPI()">测试发送邮件验证码API</button>
            <div id="api-result" class="status info">点击按钮测试API接口</div>
        </div>

        <div class="test-section">
            <h3>3. 错误处理测试</h3>
            <button onclick="testInvalidEmail()">测试无效邮箱</button>
            <button onclick="testInvalidCode()">测试无效验证码</button>
            <button onclick="testPasswordMismatch()">测试密码不匹配</button>
            <div id="error-result" class="status info">点击按钮测试错误处理</div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let testEmail = '';
        let testCode = '';

        // 更新步骤指示器
        function updateStepIndicator(step) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < step) {
                    stepElement.className = 'step completed';
                } else if (i === step) {
                    stepElement.className = 'step active';
                } else {
                    stepElement.className = 'step';
                }
            }
        }

        // 显示步骤内容
        function showStep(step) {
            document.getElementById('step1-content').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('step2-content').style.display = step === 2 ? 'block' : 'none';
            document.getElementById('step3-content').style.display = step === 3 ? 'block' : 'none';
            updateStepIndicator(step);
        }

        // 测试忘记密码
        async function testForgotPassword() {
            const email = document.getElementById('email').value;
            const resultDiv = document.getElementById('test-result');

            if (!email) {
                resultDiv.className = 'status error';
                resultDiv.textContent = '请输入邮箱地址';
                return;
            }

            resultDiv.className = 'status info';
            resultDiv.textContent = '正在发送重置邮件...';

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok && data.code === 200) {
                    resultDiv.className = 'status success';
                    resultDiv.textContent = `重置邮件发送成功: ${data.message}`;
                    testEmail = email;
                    currentStep = 2;
                    showStep(2);
                } else {
                    resultDiv.className = 'status error';
                    resultDiv.textContent = `发送失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `测试失败: ${error.message}`;
            }
        }

        // 测试验证码验证
        async function testVerifyCode() {
            const code = document.getElementById('code').value;
            const resultDiv = document.getElementById('test-result');

            if (!code || code.length !== 6) {
                resultDiv.className = 'status error';
                resultDiv.textContent = '请输入6位验证码';
                return;
            }

            resultDiv.className = 'status info';
            resultDiv.textContent = '正在验证验证码...';

            try {
                // 这里应该调用验证码验证API，但后端没有单独的验证接口
                // 我们直接进入下一步
                resultDiv.className = 'status success';
                resultDiv.textContent = '验证码验证成功';
                testCode = code;
                currentStep = 3;
                showStep(3);
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `验证失败: ${error.message}`;
            }
        }

        // 测试重新发送验证码
        async function testResendCode() {
            const resultDiv = document.getElementById('test-result');

            resultDiv.className = 'status info';
            resultDiv.textContent = '正在重新发送验证码...';

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: testEmail })
                });

                const data = await response.json();

                if (response.ok && data.code === 200) {
                    resultDiv.className = 'status success';
                    resultDiv.textContent = `验证码重新发送成功: ${data.message}`;
                } else {
                    resultDiv.className = 'status error';
                    resultDiv.textContent = `重新发送失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `重新发送失败: ${error.message}`;
            }
        }

        // 测试重置密码
        async function testResetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resultDiv = document.getElementById('test-result');

            if (!newPassword || newPassword.length < 6) {
                resultDiv.className = 'status error';
                resultDiv.textContent = '密码长度至少6位';
                return;
            }

            if (newPassword !== confirmPassword) {
                resultDiv.className = 'status error';
                resultDiv.textContent = '两次输入的密码不一致';
                return;
            }

            resultDiv.className = 'status info';
            resultDiv.textContent = '正在重置密码...';

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        code: testCode,
                        password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.code === 200) {
                    resultDiv.className = 'status success';
                    resultDiv.textContent = `密码重置成功: ${data.message}`;
                    // 重置测试状态
                    currentStep = 1;
                    showStep(1);
                    document.getElementById('email').value = '';
                    document.getElementById('code').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    resultDiv.className = 'status error';
                    resultDiv.textContent = `重置失败: ${data.message || '未知错误'}`;
                }
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `重置失败: ${error.message}`;
            }
        }

        // API接口测试
        async function testForgotPasswordAPI() {
            const resultDiv = document.getElementById('api-result');

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: 'test@example.com' })
                });

                const data = await response.json();

                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>忘记密码API测试结果:</strong><br>
                    - 状态码: ${response.status}<br>
                    - 响应: ${JSON.stringify(data, null, 2)}<br>
                    - 预期: { code: 200, message: "Password reset code sent successfully" }
                `;
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `API测试失败: ${error.message}`;
            }
        }

        async function testResetPasswordAPI() {
            const resultDiv = document.getElementById('api-result');

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        code: '123456',
                        password: 'newpassword123'
                    })
                });

                const data = await response.json();

                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>重置密码API测试结果:</strong><br>
                    - 状态码: ${response.status}<br>
                    - 响应: ${JSON.stringify(data, null, 2)}<br>
                    - 预期: { code: 200, message: "Password reset successfully" }
                `;
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `API测试失败: ${error.message}`;
            }
        }

        async function testSendEmailCodeAPI() {
            const resultDiv = document.getElementById('api-result');

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/send-email-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        type: 'reset_password'
                    })
                });

                const data = await response.json();

                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>发送邮件验证码API测试结果:</strong><br>
                    - 状态码: ${response.status}<br>
                    - 响应: ${JSON.stringify(data, null, 2)}<br>
                    - 预期: { code: 200, message: "Verification code sent successfully" }
                `;
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.textContent = `API测试失败: ${error.message}`;
            }
        }

        // 错误处理测试
        function testInvalidEmail() {
            const resultDiv = document.getElementById('error-result');
            resultDiv.className = 'status success';
            resultDiv.innerHTML = `
                <strong>无效邮箱测试:</strong><br>
                - 空邮箱: 应该显示"请输入邮箱地址"<br>
                - 无效格式: 应该显示"请输入有效的邮箱地址"<br>
                - 不存在的邮箱: 应该显示"User not found"
            `;
        }

        function testInvalidCode() {
            const resultDiv = document.getElementById('error-result');
            resultDiv.className = 'status success';
            resultDiv.innerHTML = `
                <strong>无效验证码测试:</strong><br>
                - 空验证码: 应该显示"请输入验证码"<br>
                - 长度不足: 应该显示"验证码必须是6位数字"<br>
                - 错误验证码: 应该显示"Invalid or expired verification code"
            `;
        }

        function testPasswordMismatch() {
            const resultDiv = document.getElementById('error-result');
            resultDiv.className = 'status success';
            resultDiv.innerHTML = `
                <strong>密码不匹配测试:</strong><br>
                - 密码长度不足: 应该显示"密码长度至少6位"<br>
                - 确认密码不匹配: 应该显示"两次输入的密码不一致"<br>
                - 密码重置成功: 应该显示"Password reset successfully"
            `;
        }
    </script>
</body>

</html>