package main

import (
	"fmt"
	"unit-auth/models"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
)

func main() {
	fmt.Println("ğŸ” è°ƒè¯•æ•°æ®åº“è¿æ¥...")

	// æµ‹è¯•å¤šç§æ•°æ®åº“è¿æ¥é…ç½®
	configs := []string{
		"root:@tcp(localhost:3306)/unit_auth?charset=utf8mb4&parseTime=True&loc=Local",
		"unit_auth:unit_auth_password@tcp(localhost:3306)/unit_auth?charset=utf8mb4&parseTime=True&loc=Local",
		"root:123456@tcp(localhost:3306)/unit_auth?charset=utf8mb4&parseTime=True&loc=Local",
	}

	for i, dsn := range configs {
		fmt.Printf("\nğŸ“ æµ‹è¯•é…ç½® %d: %s\n", i+1, dsn)

		db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
			Logger: logger.Default.LogMode(logger.Silent),
		})

		if err != nil {
			fmt.Printf("   âŒ è¿æ¥å¤±è´¥: %v\n", err)
			continue
		}

		// æ£€æŸ¥Refresh Tokenè¡¨
		var count int64
		if err := db.Model(&models.RefreshToken{}).Count(&count).Error; err != nil {
			fmt.Printf("   âš ï¸  Refresh Tokenè¡¨ä¸å­˜åœ¨æˆ–æŸ¥è¯¢å¤±è´¥: %v\n", err)

			// å°è¯•åˆ›å»ºè¡¨
			fmt.Printf("   ğŸ”„ å°è¯•åˆ›å»ºRefresh Tokenè¡¨...\n")
			if err := db.AutoMigrate(&models.RefreshToken{}); err != nil {
				fmt.Printf("   âŒ åˆ›å»ºè¡¨å¤±è´¥: %v\n", err)
			} else {
				fmt.Printf("   âœ… Refresh Tokenè¡¨åˆ›å»ºæˆåŠŸ\n")
			}
		} else {
			fmt.Printf("   âœ… Refresh Tokenè¡¨å­˜åœ¨ï¼Œè®°å½•æ•°: %d\n", count)
		}

		// æ˜¾ç¤ºè¡¨åˆ—è¡¨
		fmt.Printf("   ğŸ“‹ æ•°æ®åº“è¡¨åˆ—è¡¨:\n")
		rows, err := db.Raw("SHOW TABLES").Rows()
		if err != nil {
			fmt.Printf("   âŒ è·å–è¡¨åˆ—è¡¨å¤±è´¥: %v\n", err)
			continue
		}
		defer rows.Close()

		tables := 0
		for rows.Next() {
			var tableName string
			if err := rows.Scan(&tableName); err != nil {
				continue
			}
			fmt.Printf("     - %s\n", tableName)
			tables++
		}

		if tables > 0 {
			fmt.Printf("   âœ… æ‰¾åˆ° %d ä¸ªè¡¨\n", tables)
			fmt.Printf("   ğŸ¯ æ¨èä½¿ç”¨é…ç½® %d\n", i+1)
			break
		} else {
			fmt.Printf("   âŒ æ•°æ®åº“ä¸­æ²¡æœ‰è¡¨\n")
		}
	}

	fmt.Println("\nğŸ“‹ å»ºè®®çš„è§£å†³æ­¥éª¤:")
	fmt.Println("1. ç¡®ä¿MySQLæœåŠ¡æ­£åœ¨è¿è¡Œ")
	fmt.Println("2. åˆ›å»ºæ•°æ®åº“: CREATE DATABASE unit_auth;")
	fmt.Println("3. åˆ›å»ºç”¨æˆ·: CREATE USER 'unit_auth'@'%' IDENTIFIED BY 'unit_auth_password';")
	fmt.Println("4. æˆæƒ: GRANT ALL PRIVILEGES ON unit_auth.* TO 'unit_auth'@'%';")
	fmt.Println("5. åˆ·æ–°: FLUSH PRIVILEGES;")
	fmt.Println("6. è¿è¡Œ: go run main.go")
}
