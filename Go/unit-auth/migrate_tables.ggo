package main

import (
	"fmt"
	"log"
	"unit-auth/models"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
)

func main() {
	// æ•°æ®åº“è¿æ¥ä¿¡æ¯
	dsn := "root:@tcp(localhost:3306)/unit_auth?charset=utf8mb4&parseTime=True&loc=Local"

	fmt.Println("ğŸ”„ è¿æ¥åˆ°æ•°æ®åº“...")
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logger.Info),
	})
	if err != nil {
		log.Fatal("âŒ è¿æ¥æ•°æ®åº“å¤±è´¥:", err)
	}

	fmt.Println("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")

	// è‡ªåŠ¨è¿ç§»æ•°æ®åº“è¡¨
	fmt.Println("ğŸ”„ å¼€å§‹è¿ç§»è¡¨ç»“æ„...")

	err = db.AutoMigrate(
		// æ ¸å¿ƒç”¨æˆ·è¡¨
		&models.User{},
		&models.EmailVerification{},
		&models.PasswordReset{},
		&models.SMSVerification{},
		&models.UserStats{},
		&models.LoginLog{},
		&models.WeChatQRSession{},
		&models.RefreshToken{}, // æ–°å¢çš„Refresh Tokenè¡¨

		// SSOæ”¯æŒ
		&models.SSOClient{},
		&models.SSOSession{},
		&models.TokenBlacklist{},

		// ä¸­å¿ƒåŒ–ç”¨æˆ·ç®¡ç†
		&models.Project{},
		&models.ProjectMapping{},
		&models.GlobalUserStats{},
		&models.AuthLog{},

		// ç”¨æˆ·ç”»åƒç³»ç»Ÿ
		&models.UserProfile{},
		&models.UserBehavior{},
		&models.UserPreference{},
		&models.UserSegment{},
		&models.UserSegmentMapping{},

		// æƒé™ç®¡ç†ç³»ç»Ÿ
		&models.Role{},
		&models.Permission{},
		&models.RolePermission{},
		&models.UserRole{},
		&models.AccessControl{},
		&models.PermissionGroup{},
		&models.PermissionGroupItem{},
		&models.AuditLog{},

		// æ•°æ®åŒæ­¥æœºåˆ¶
		&models.SyncTask{},
		&models.SyncLog{},
		&models.DataChange{},
		&models.SyncMapping{},
		&models.SyncConflict{},
		&models.SyncCheckpoint{},

		// ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
		&models.Metric{},
		&models.MetricValue{},
		&models.AlertRule{},
		&models.Alert{},
		&models.Notification{},
		&models.NotificationTemplate{},
		&models.SystemHealth{},
		&models.PerformanceLog{},
	)

	if err != nil {
		log.Fatal("âŒ è¿ç§»å¤±è´¥:", err)
	}

	fmt.Println("âœ… æ‰€æœ‰è¡¨è¿ç§»æˆåŠŸ")

	// æ£€æŸ¥Refresh Tokenè¡¨æ˜¯å¦å­˜åœ¨
	var count int64
	if err := db.Model(&models.RefreshToken{}).Count(&count).Error; err != nil {
		fmt.Printf("âš ï¸  æ£€æŸ¥Refresh Tokenè¡¨å¤±è´¥: %v\n", err)
	} else {
		fmt.Printf("âœ… Refresh Tokenè¡¨åˆ›å»ºæˆåŠŸï¼Œå½“å‰è®°å½•æ•°: %d\n", count)
	}

	// æ˜¾ç¤ºæ‰€æœ‰è¡¨
	fmt.Println("\nğŸ“‹ æ•°æ®åº“è¡¨åˆ—è¡¨:")
	rows, err := db.Raw("SHOW TABLES").Rows()
	if err != nil {
		log.Fatal("âŒ è·å–è¡¨åˆ—è¡¨å¤±è´¥:", err)
	}
	defer rows.Close()

	for rows.Next() {
		var tableName string
		if err := rows.Scan(&tableName); err != nil {
			continue
		}
		if tableName == "refresh_tokens" || tableName == "users" || tableName == "sso_clients" {
			fmt.Printf("  âœ… %s\n", tableName)
		}
	}

	fmt.Println("\nğŸ‰ æ•°æ®åº“è¿ç§»å®Œæˆï¼")
}
