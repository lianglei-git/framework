
1. 单点登录

流程如下：

2. token续签


进入A项目(aaa.cn)，首次登录会跳转到unit-auth的登录页。用户进行登录。然后返回jwt
[5 tools called]

## SSO登录后返回的信息

### 1. **OAuth Token响应** (`/oauth/token`)
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",  // JWT访问令牌
  "refresh_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...", // JWT刷新令牌
  "token_type": "Bearer",
  "expires_in": 3600,                    // 过期时间（秒）
  "scope": "openid profile email phone"   // 权限范围
}
```

### 2. **JWT Token内容** (解码后)
```json
{
  "iss": "unit-auth-server",    // 签发者
  "sub": "user123",             // 用户ID
  "aud": "aa.cn",               // 受众（请求的应用）
  "exp": 1640995200,           // 过期时间戳
  "iat": 1640991600,           // 签发时间戳
  "jti": "unique-token-id",    // 唯一令牌ID
  "roles": ["user"],           // 用户角色
  "scope": "openid profile email"
}
```

### 3. **用户信息响应** (`/oauth/userinfo`)
```json
{
  "sub": "user123",                    // 用户ID
  "name": "张三",                      // 用户名
  "preferred_username": "zhangsan",    // 首选用户名
  "nickname": "三儿",                  // 昵称
  "email": "zhangsan@example.com",     // 邮箱
  "email_verified": true,              // 邮箱是否验证
  "phone_number": "13800138000",       // 手机号
  "phone_number_verified": true,       // 手机号是否验证
  "avatar": "https://...",             // 头像URL（从meta字段）
  "custom_claims": {                   // 自定义字段
    "original_user": {
      "id": "user123",
      "username": "zhangsan",
      "email": "zhangsan@example.com",
      // ... 完整用户信息
    }
  }
}
```

### 4. **SSO会话信息**
```json
{
  "session_id": "sso_1640991600_abc123",  // SSO会话ID
  "user_id": "user123",                   // 用户ID
  "client_id": "aa.cn",                   // 客户端ID
  "authenticated_at": 1640991600,         // 认证时间
  "expires_at": 1640995200,               // 过期时间
  "last_activity": 1640991600,            // 最后活动时间
  "is_active": true,                      // 是否活跃
  "remember_me": false                    // 是否记住登录
}
```

### 5. **完整登录流程返回**

**第一步：获取授权码**
```
用户在aa.cn登录 → 跳转到unit-auth/oauth/authorize → 登录成功 → 获取授权码
```

**第二步：换取Token**
```
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=auth_code_123&
client_id=aa.cn&
client_secret=secret&
redirect_uri=https://aa.cn/callback
```

**第三步：获取用户信息**
```
GET /oauth/userinfo
Authorization: Bearer eyJhbGciOiJSUzI1NiIs...
```

**返回信息总结：**
- ✅ **访问令牌** - JWT格式，支持跨项目验证
- ✅ **刷新令牌** - 支持Token续签
- ✅ **用户信息** - 完整的用户资料
- ✅ **会话信息** - SSO会话状态管理
- ✅ **权限范围** - 细粒度权限控制


## SSO会话的作用和存储必要性

### 1. **核心作用**

**会话状态管理**
- 跟踪用户登录状态：`is_active: true/false`
- 记录认证时间：`authenticated_at`
- 管理会话生命周期：`expires_at`

**跨域认证支持**
- 在多个域名间保持登录状态
- 支持Token续签机制
- 实现"记住我"功能

### 2. **安全保障**

**防止会话劫持**
```json
{
  "session_id": "sso_1640991600_abc123",  // 唯一会话标识
  "user_id": "user123",                   // 用户绑定
  "client_id": "aa.cn",                   // 客户端限制
  "jti": "unique-token-id"               // 令牌唯一性检查
}
```

**重放攻击防护**
- 每个会话有唯一ID，防止重放
- 过期时间严格控制
- 支持强制注销机制

### 3. **功能支持**

**单点登出**
- 注销时清理所有相关会话
- 跨项目统一登出
- 防止已登出用户继续访问

**审计和监控**
```json
{
  "last_activity": 1640991600,    // 最后活动时间
  "ip_address": "192.168.1.100", // IP地址
  "user_agent": "Mozilla/5.0..." // 浏览器信息
}
```

### 4. **性能优化**

**减少数据库查询**
- 会话信息缓存用户状态
- 避免频繁查询用户表
- 支持快速会话验证

**会话续签机制**
```json
{
  "expires_at": 1640995200,       // 1小时后过期
  "remember_me": false,           // 短期会话
  // 自动续签逻辑
}
```

### 5. **存储必要性**

**为什么必须存储：**
1. **状态持久化** - 重启后保持登录状态
2. **跨请求一致性** - 保证同一用户同一状态
3. **安全审计** - 记录所有登录活动
4. **会话清理** - 自动清理过期会话
5. **分布式支持** - 多服务器间状态同步

**存储位置：**
- **数据库** - 持久化存储
- **Redis缓存** - 高性能访问
- **本地存储** - 短期会话信息

### 6. **实际使用场景**

**场景1：跨项目访问**
```
用户在aa.cn登录 → 访问bb.cn
bb.cn检查SSO会话 → 自动登录
```

**场景2：Token过期处理**
```
会话即将过期 → 自动续签Token
更新会话时间 → 继续保持登录
```

**场景3：异常检测**
```
异常IP访问 → 检查会话信息
发现可疑活动 → 强制注销
```

### 7. **会话生命周期**

**创建** → **活跃使用** → **续签** → **过期清理**

- ✅ **会话创建** - 登录成功时
- ✅ **状态跟踪** - 每次API调用更新
- ✅ **自动续签** - 即将过期时刷新
- ✅ **过期清理** - 定期清理无效会话
- ✅ **异常注销** - 发现问题时强制清除

**总结：** SSO会话是整个单点登录系统的"大脑"，负责状态管理、安全防护、性能优化和功能支持。没有会话存储，SSO就无法实现跨域登录、自动续签、统一登出等核心功能。